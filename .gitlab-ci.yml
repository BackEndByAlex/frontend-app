# ─────────────────────────────────────────────────────────────
# SSH-setup-anchor (används bara i deploy-steget)
# ─────────────────────────────────────────────────────────────
.before_script_ssh_setup: &before_script_ssh_setup
  # Se till att ssh-agent finns
  - command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install -y openssh-client -y )
  # Starta ssh-agent
  - eval $(ssh-agent -s)
  # Lägg till privat SSH-nyckel från CI-variabeln
  - chmod 600 "$SSH_PRIVATE_KEY"
  - ssh-add "$SSH_PRIVATE_KEY"
  # Skapa ~/.ssh och sätt behörigheter
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  # Lägg till värdservern i known_hosts
  - ssh-keyscan -H "$PRODUCTION_HOST" >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

# ─────────────────────────────────────────────────────────────
# Config-injektion-anchor (skapar config/.env och config/public.pem)
# ─────────────────────────────────────────────────────────────
.build_config: &build_config
  before_script:
    - mkdir -p config
    - echo "$DOTENV_FILE"  > config/.env
    - echo "$PUBLIC_PEM"   > config/public.pem

# ─────────────────────────────────────────────────────────────
# Basimage med Docker CLI
# ─────────────────────────────────────────────────────────────
image: docker:27-cli

# ─────────────────────────────────────────────────────────────
# Definiera pipelinens steg
# ─────────────────────────────────────────────────────────────
stages:
  - build
  - test
  - deploy

# ─────────────────────────────────────────────────────────────
# 1) Kompilera koden (med config-injektion om File-variabler används)
# ─────────────────────────────────────────────────────────────
build-job:
  stage: build
  <<: *build_config
  script:
    - echo "Generating config files..."
    - mkdir -p config
    - echo "$DOTENV_FILE" > config/.env
    - echo "$PUBLIC_PEM"  > config/public.pem
    - echo "Building Docker image..."
    - docker build -t my-frontend-app .

# ─────────────────────────────────────────────────────────────
# 2) Unit-tester
# ─────────────────────────────────────────────────────────────
unit-test-job:
  stage: test
  script:
    - echo "Running unit tests... This will take about 60 seconds."
    - sleep 2   # Simulerar testtid
    - echo "Code coverage is 90%"

# ─────────────────────────────────────────────────────────────
# 3) Lint
# ─────────────────────────────────────────────────────────────
lint-test-job:
  stage: test
  script:
    - echo "Linting code... This will take about 10 seconds."
    - sleep 2   # Simulerar linttid
    - echo "No lint issues found."

# ─────────────────────────────────────────────────────────────
# 4) Deploy till produktion via Docker-over-SSH
# ─────────────────────────────────────────────────────────────
deploy_production_job:
  stage: deploy
  environment:
    name: production
    url: http://$PRODUCTION_HOST
  variables:
    PRODUCTION_HOST: cscloud7-142.lnu.se
    DEPLOY_USER:     ubuntu
    DOCKER_HOST:     ssh://$DEPLOY_USER@$PRODUCTION_HOST
  before_script:
    - *before_script_ssh_setup
  script:
    - echo "Deploying to production..."
    - docker compose -f docker-compose.yaml up --build -d
  only:
    - main
  needs:
    - unit-test-job
    - lint-test-job
